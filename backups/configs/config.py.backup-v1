"""
Zentrale Konfiguration f√ºr Borgo-Bot v3.71
Multi-Umgebungs-Support mit dynamischer Gruppenwahl
"""

# =====================================================================================
# BASIsS-INFO
# =====================================================================================

BOT_VERSION = "3.71"
BOT_NAME = "Borgo-Bot"
BOT_COMMAND_PREFIX = "!bot"

# =====================================================================================
# SIGNAL KONFIGURATION
# =====================================================================================

# Voller Pfad zur signal-cli Installation
SIGNAL_CLI_PATH = "/opt/homebrew/bin/signal-cli"

# Account-Nummer des Bots
SIGNAL_ACCOUNT = "+4915755901211"
SIGNAL_PHONE_NUMBER = "+4915755901211"  # Alias

# ========================================
# UMGEBUNGS-KONFIGURATION & SIGNAL-GRUPPEN
# ========================================

import os

ENVIRONMENT = os.getenv('BORGO_ENV', 'development')

# Signal-Gruppen-IDs nach Umgebung
SIGNAL_GROUPS = {
    'development': ['i4UA7hmoTi1HYq+vO0/NvyR/MEcqKfLTrODlw9W8dDM='],  # Borgo-Bot DEV
    'test': ['21oiqcpO37/ScyKFhmctf/45MQ5QYdN2h/VQp9WMKCM='],        # Borgo-Bot TEST  
    'production': ['GIRAgoi6g+wpsFCliNWoXPXAErU/li2tW8TQ1xKhqcE='],  # Borgo-Bot Community-Test
}

# Aktive Gruppen f√ºr diese Umgebung (als Liste f√ºr Kompatibilit√§t mit Multi-Worker)
SIGNAL_GROUP_ID = SIGNAL_GROUPS.get(ENVIRONMENT, SIGNAL_GROUPS['development'])

# Socket-Pfad f√ºr Daemon-Kommunikation
SIGNAL_SOCKET_PATH = '/tmp/signal-cli-socket'

# Safety-Logging beim Import
if __name__ != "__main__":
    env_name = {'development': 'DEV', 'test': 'TEST', 'production': 'PROD'}.get(ENVIRONMENT, ENVIRONMENT)
    print(f"ü§ñ Borgo-Bot v{BOT_VERSION} | {env_name} | ‚Üí {len(SIGNAL_GROUP_ID)} group(s)")

# Signal-CLI Settings
SIGNAL_RECEIVE_TIMEOUT = 45
SIGNAL_RECEIVE_BACKOFF = [1, 2, 5, 10]
MAX_MESSAGE_LENGTH = 4096  # Signal-Limit

# =====================================================================================
# LLM KONFIGURATION
# =====================================================================================

# Modell-Hierarchie f√ºr Fallback
LLM_MODELS = [
    'mistral:instruct',     # Prim√§r
    'granite3.3:2b',        # Fallback 1
    'llama3.2:latest'       # Fallback 2
]

PRIMARY_MODEL = LLM_MODELS[0]
SECONDARY_MODEL = 'granite3.3:2b'

MAX_LLM_RETRIES = 2
LLM_TIMEOUT_SECONDS = 60
MODEL_TIMEOUT_SECONDS = 30

# Context-Limits
MAX_CONTEXT_WORDS = 800
MAX_CONTEXT_ENTRIES = 3

# =====================================================================================
# INPUT VALIDATION
# =====================================================================================

MIN_INPUT_LENGTH = 3
MAX_INPUT_LENGTH = 500

PROBLEMATIC_PATTERNS = [
    r'^\s*$',
    r'^[!?.,;:\-_/\\]+$',
    r'^(.)\1{20,}',
    r'^[0-9]{50,}',
]

INVALID_INPUT_PATTERNS = [
    r"^[!?.,;:\-\s]+$",
    r"^[0-9\s]+$",
    r"^[A-Za-z]{1,2}$",
]

# Meta/Playful Queries (questions about the bot itself, not Borgo topics)
META_QUERY_PATTERNS = [
    r'\bferien\b',
    r'\burlaub\b',
    r'\bpause\b',
    r'\bfrei\s+(haben|machen)\b',
    r'\bschlafen\b',
    r'\bm√ºde\b',
    r'\bausruhen\b',
    r'\bwochenende\b',
    r'\bfreizeit\b',
]

QUICK_RESPONSES = {
    "ping": "pong",
    "test": f"Borgo-Bot v{BOT_VERSION} l√§uft.",
    "status": f"Borgo-Bot v{BOT_VERSION} online und bereit.",
    "version": f"Borgo-Bot v{BOT_VERSION}",
}

# =====================================================================================
# KEYWORD EXTRAKTION
# =====================================================================================

KEYWORD_CONFIDENCE = {
    'high': 0.95,
    'medium': 0.75,
    'low': 0.50
}

FUZZY_MATCH_THRESHOLD = 80
MIN_KEYWORDS_REQUIRED = 0

# =====================================================================================
# CONTEXT MANAGER / YAML HANDLING
# =====================================================================================

CONTEXT_MIXING_RULES = {
    'pizza': ['rasenm√§her', 'benzin', 'startleine', 'motor'],
    'hunde': ['s√§ureabfallt√ºchel', 'sp√ºlen im hinterhof'],
    'schlangen': ['schlangenwurm', 'absetzen', 'sp√ºlen'],
}

CONTEXT_FALLBACK_CATEGORIES = {
    "tiere": "tierinfo",
    "notfall": "emergency",
    "pizza": "cooking",
    "heizung": "heating",
}

YAML_DB_PATH = "borgo_knowledge_base.yaml"
YAML_CATEGORIES = [
    'basics', 'facilities', 'safety', 'rules', 'contact',
    'emergency', 'faq', 'seasonal', 'technical', 'general'
]

# =====================================================================================
# HALLUZINATIONS-ERKENNUNG
# =====================================================================================

HALLUCINATION_PATTERNS = [
    # Falsche Einheiten/Messungen
    (r'\d+\s*Viertel\s*Tonne', 'Viertel Tonne'),
    (r'\d+\.\d{3,}\s*kg', 'Zu pr√§zise Gewichtsangabe'),
    (r'\d+\s*Gallone[n]?', 'Gallonen (falsche Einheit)'),
    
    # Erfundene spezifische Details (KRITISCH!)
    (r'\bCode\s+\d{4,}\b', 'Spezifischer Zahlencode (wahrscheinlich erfunden)'),
    (r'\bTresor.*Code\b', 'Tresor-Code Details (nicht verifiziert)'),
    (r'\b\d{1,2}:\d{2}\s*Uhr\b', 'Spezifische Uhrzeit (m√∂glicherweise erfunden)'),
    (r'\bZimmer\s+\d+\b', 'Spezifische Zimmernummer (m√∂glicherweise erfunden)'),
    (r'\bTelefon:?\s*\+?\d{6,}', 'Spezifische Telefonnummer (m√∂glicherweise erfunden)'),
    
    # Erfundene Begriffe
    (r'S√§ureabfallt√ºchel', 'Erfundener Begriff'),
    (r'Schlangenwurm', 'Erfundenes Tier'),
    (r'Pflanzenmanager', 'Erfundene Rolle'),
    
    # Kontext-Vermischungen
    (r'Rasenm√§her.*Pizza', 'Pizza/Rasenm√§her verwechselt'),
    (r'Startleine.*Pizzaofen', 'Pizzaofen/Motor verwechselt'),
]

# =====================================================================================
# RESPONSE VALIDATION
# =====================================================================================

MIN_RESPONSE_LENGTH = 10
MAX_RESPONSE_LENGTH = 2000

QUALITY_CHECKS = {
    'too_short': MIN_RESPONSE_LENGTH,
    'too_long': MAX_RESPONSE_LENGTH,
    'hallucination': True,
    'context_mixing': True,
    'incomplete': True,
}

FORBIDDEN_PHRASES = [
    "Ich bin ein Sprachmodell",
    "Als KI",
    "OpenAI",
    "ChatGPT",
    "Ich bin Claude",
    "Ich bin Mistral",
    "Ich bin ein AI",
    "k√ºnstliche Intelligenz",
    "Ich mache Ferien nicht",  # Robotic phrasing
    "Ich mache keine Ferien",  # Robotic phrasing
]

# =====================================================================================
# FALLBACK SYSTEM
# =====================================================================================

FALLBACK_RESPONSES = {
    'no_keywords': """Dazu habe ich leider keine Informationen im Benvenuti-Guide. 

Ich kann dir bei folgenden Themen helfen:
- WLAN und Internet
- Pizzaofen Benutzung
- M√ºll und Recycling
- Hunde im Borgo
- Schlangen und Sicherheit
- Notf√§lle und Kontakte

Stelle eine konkrete Frage zu einem dieser Themen!""",
    
    'meta_query': """Ich bin 24/7 f√ºr euch da! ü§ñ

F√ºr Borgo-Fragen stehe ich immer zur Verf√ºgung. Stelle mir gerne eine konkrete Frage zu:
‚Ä¢ Einrichtungen (Pizzaofen, Pools, WLAN)
‚Ä¢ Hausregeln und Check-in/out
‚Ä¢ Notf√§lle und Sicherheit""",
    
    'llm_error': """Entschuldigung, ich hatte ein technisches Problem beim Verarbeiten deiner Frage.

Bitte versuche:
1. Deine Frage etwas anders zu formulieren
2. Eine konkretere Frage zu stellen
3. Die Onsite-Gruppe zu kontaktieren

Danke f√ºr dein Verst√§ndnis! üôè""",
    
    'ambiguous': """Deine Frage ist mir nicht ganz klar. Bitte formuliere sie konkreter.

Beispiel:
‚ùå "Info"
‚úÖ "Wie funktioniert der Pizzaofen?"

‚ùå "Tiere?"
‚úÖ "Sind Hunde im Borgo erlaubt?"

Ich helfe dir gerne weiter! üòä""",
    
    'out_of_scope': """Diese Frage geh√∂rt nicht zu meinen Themen. Ich bin spezialisiert auf:

üì± Borgo-Einrichtungen (Pizzaofen, WLAN, etc.)
üè† G√§ste-Services (Anreise, Check-in, Hausregeln)
üö® Notf√§lle und Sicherheit

F√ºr andere Themen kontaktiere bitte die Borgo-Community direkt.""",

    'validation_failed': """Ich konnte leider keine sichere Antwort auf deine Frage formulieren.

Bitte kontaktiere die Onsite-Gruppe f√ºr verl√§ssliche Informationen.

Du kannst auch im Benvenuti-Guide nachschauen: [Link zur Dokumentation]""",

    'too_many_retries': """Nach mehreren Versuchen konnte ich keine zufriedenstellende Antwort generieren.

Das tut mir leid! Bitte:
- Kontaktiere die Onsite-Gruppe direkt
- Schaue im Benvenuti-Guide nach
- Versuche es sp√§ter nochmal

Ich lerne st√§ndig dazu! ü§ñ""",

    'unknown': """Entschuldigung, ein unerwarteter Fehler ist aufgetreten.

Bitte versuche es erneut oder kontaktiere die Onsite-Gruppe f√ºr Hilfe.

Die technischen Details wurden geloggt. üîß""",
    
    'NO_KEYWORDS': "Ich konnte keine relevanten Informationen finden.",
    'AMBIGUOUS': "Deine Frage ist mehrdeutig ‚Äì kannst du sie pr√§zisieren?",
    'VALIDATION_FAILED': "Die Eingabe enth√§lt problematische Inhalte.",
    'LLM_ERROR': "Es gab ein Problem beim Generieren der Antwort.",
    'UNKNOWN': "Ein unerwarteter Fehler ist aufgetreten.",
}

# =====================================================================================
# MONITORING & LOGGING
# =====================================================================================

LOG_LEVEL = "DEBUG"  # ‚Üê Debug aktivieren
LOG_FILE = "borgo_bot_v3_5.log"
LOG_ROTATION_MB = 10
LOG_RETENTION_DAYS = 30

METRICS_FILE = "borgo_bot_metrics.json"
MAX_LOG_ENTRIES = 5000

TRACK_METRICS = {
    'query_processing_time': True,
    'llm_response_time': True,
    'keyword_extraction_time': True,
    'validation_time': True,
    'signal_send_time': True,
}

ALERT_THRESHOLDS = {
    'slow_response_seconds': 10,
    'high_error_rate_percent': 20,
    'hallucination_count_per_hour': 5,
}

# =====================================================================================
# WORKER KONFIGURATION
# =====================================================================================

NUM_WORKERS = 3
QUEUE_TIMEOUT_SECONDS = 60

# =====================================================================================
# DEVELOPMENT & TESTING
# =====================================================================================

DEBUG_MODE = False
TEST_MODE = False
DRY_RUN = False

TEST_QUERIES = [
    "Wie viel Mehl f√ºr 24 Personen Pizza?",
    "Ich habe eine Schlange gesehen",
    "Sind Hunde erlaubt?",
    "Wie funktioniert der Pizzaofen?",
    "WLAN Passwort?",
]

# =====================================================================================
# FEATURES FLAGS
# =====================================================================================

FEATURES = {
    'input_validation': True,
    'keyword_confidence_scoring': True,
    'context_isolation': True,
    'hallucination_detection': True,
    'multi_model_fallback': True,
    'fuzzy_keyword_matching': True,
    'response_validation': True,
    'detailed_logging': True,
}

# =====================================================================================
# HILFSFUNKTIONEN
# =====================================================================================

def is_meta_query(text):
    """
    Pr√ºft ob eine Frage √ºber den Bot selbst ist (Ferien, M√ºdigkeit, etc.)
    statt √ºber Borgo-Themen.
    
    Returns:
        bool: True wenn Meta-Query erkannt wurde
    """
    import re
    text_lower = text.lower()
    
    for pattern in META_QUERY_PATTERNS:
        if re.search(pattern, text_lower):
            return True
    return False

def get_feature_status():
    """Gibt Status aller Features zur√ºck"""
    enabled = [k for k, v in FEATURES.items() if v]
    disabled = [k for k, v in FEATURES.items() if not v]
    return {
        'enabled': enabled,
        'disabled': disabled,
        'total': len(FEATURES)
    }

def validate_config():
    """Validiert Konfiguration"""
    errors = []
    
    if not LLM_MODELS:
        errors.append("LLM_MODELS darf nicht leer sein")
    
    if not SIGNAL_ACCOUNT:
        errors.append("SIGNAL_ACCOUNT muss gesetzt sein")
    
    if MIN_INPUT_LENGTH < 1:
        errors.append("MIN_INPUT_LENGTH muss >= 1 sein")
    
    # Environment-Checks
    if ENVIRONMENT not in SIGNAL_GROUPS:
        errors.append(f"ENVIRONMENT '{ENVIRONMENT}' nicht in SIGNAL_GROUPS definiert")
    
    if not SIGNAL_GROUP_ID:
        errors.append("SIGNAL_GROUP_ID ist leer - keine Zielgruppe definiert")
    
    return errors

if __name__ == "__main__":
    print(f"Borgo-Bot v{BOT_VERSION} Configuration")
    print("=" * 50)
    
    # Environment Info
    env_name = {'development': 'DEV', 'test': 'TEST', 'production': 'PROD'}.get(ENVIRONMENT, ENVIRONMENT)
    print(f"\nüåç Environment: {env_name} ({ENVIRONMENT})")
    
    status = get_feature_status()
    print(f"\n‚úÖ Aktivierte Features: {len(status['enabled'])}/{status['total']}")
    for feature in status['enabled']:
        print(f"   ‚Ä¢ {feature}")
    
    print("\nüîç Konfiguration validieren...")
    errors = validate_config()
    if errors:
        print("‚ùå Fehler gefunden:")
        for error in errors:
            print(f"   ‚Ä¢ {error}")
    else:
        print("‚úÖ Konfiguration OK!")
    
    # Zeige Gruppen-Konfiguration
    print(f"\nüì° Signal-Gruppen-Konfiguration:")
    for env, groups in SIGNAL_GROUPS.items():
        marker = "‚Üí" if env == ENVIRONMENT else " "
        env_label = {'development': 'DEV', 'test': 'TEST', 'production': 'PROD'}.get(env, env)
        print(f"   {marker} {env_label:12} : {len(groups)} Gruppe(n)")
    
    print(f"\n   Aktiv: {len(SIGNAL_GROUP_ID)} Gruppe(n)")
    for i, gid in enumerate(SIGNAL_GROUP_ID, 1):
        print(f"   {i}. {gid[:40]}...")
    
    print("\n" + "=" * 50)
# OVERRIDE f√ºr Multi-Bot System:
#
# OVERRIDE fuer Multi-Bot System:
SIGNAL_GROUP_ID = None